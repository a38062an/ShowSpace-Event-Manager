<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default}">
<head>
    <title th:text="${event.name}">Event Details</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.js"></script>
    <style>
        .card {
            max-width: 600px;
            margin: auto;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            transition: transform 0.2s;
            background-color: #ffffff;
        }
        .card:hover {
            transform: scale(1.02);
        }
        .event-icon {
            font-size: 22px;
            color: #007bff;
            margin-right: 10px;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        .mastodon-card {
        	margin-top: 30px;
		    max-width: 1000px;
		    font-size: 18px;
		}
        #map {
            width: 100%;
            height: 400px;
            margin-top: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
<div layout:fragment="content" class="container py-5">
    <div class="card text-center">
        <h2 class="mb-4 text-primary">
            <i class="fa-solid fa-calendar-check"></i> <span th:text="${event.name}">Event Name</span>
        </h2>
        <p><i class="fa-solid fa-map-marker-alt event-icon"></i><strong>Venue:</strong>
            <span>
	                <a th:href="@{/venues/{id}(id=${event.venue.id})}" th:text="${event.venue.name}">Venue Name</a>
            	</span>
        </p>
        <p><i class="fa-solid fa-calendar event-icon"></i><strong>Date:</strong> <span th:text="${event.date}">Event Date</span></p>
        <p><i class="fa-solid fa-clock event-icon"></i><strong>Time:</strong> <span th:text="${event.time}">Event Time</span></p>
        <p>
            <i class="fa-solid fa-file-alt event-icon"></i>
            <strong>Description:</strong>
        </p>
        <p th:text="${event.description}" style="white-space: pre-line;">
            Event Description
        </p>
        <div class="btn-group">
            <a href="/events" class="btn btn-secondary btn-lg rounded-end">
                <i class="fa-solid fa-arrow-left"></i> Back to Events
            </a>
			<a th:if="${#authorization.expression('hasRole(''ROLE_ADMINISTRATOR'')') and event.date.isAfter(T(java.time.LocalDate).now())}"
			   th:href="@{/events/{id}/edit(id=${event.id})}"
			   class="btn btn-warning btn-lg">
			    <i class="fas fa-edit"></i> Edit Event
			</a>
            <form th:if="${#authorization.expression('hasRole(''ROLE_ADMINISTRATOR'')')}"
                  th:action="@{/events/{id}(id=${event.id})}"
                  th:method="delete" style="display:inline;"
                  onsubmit="return confirm('Are you sure you want to delete this event?');">
                <button type="submit" class="btn btn-danger btn-lg">
                    <i class="fas fa-trash"></i> Delete Event
                </button>
            </form>
        </div>
    </div>
    
    <!-- MASTODON POST -->
	<div class="card mastodon-card">
        <form th:action="@{/events/{id}(id=${event.id})}" th:method="post">
            <div class="form-group">
            	<div th:if="${ok_message}" class="alert alert-success" style="font-size: 0.85em;">
				    <i class="fa-solid fa-check-circle"></i> Your post: <strong th:text="${ok_message}"></strong> was posted
				</div>
		        <p><strong>Share the event!</strong></p>
		        <textarea class="form-control" id="content" name="content" 
		        	th:placeholder="'#' + ${#strings.replace(event.name, ' ', '_')}"></textarea>
		        <small class="text-danger" th:if="${error}" th:text="${error}"></small>
		    </div>
            <button type="submit" class="btn btn-success" style="margin-top: 20px">
            	<i class="fa-solid fa-paper-plane"></i> Submit Post
            </button>
        </form>
	</div>

    <!-- MAP -->
    <div id="map"></div>
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            mapboxgl.accessToken = /*[[${mapToken}]]*/ '';
            // Correct Thymeleaf expression for script tags
            const longitude = [[${event.venue.longitude}]];
            const latitude = [[${event.venue.latitude}]];
            const venueName = [[${event.venue.name}]];
            const eventName = [[${event.name}]];
            const eventTime = [[${event.time}]];

            const map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v11',
                center: [longitude, latitude],
                zoom: 12
            });

            // Add marker for the venue
            const startTime = eventTime !== null && eventTime !== undefined ? `Starts at ${eventTime}` : 'No start time set';
              new mapboxgl.Marker()
                      .setLngLat([longitude, latitude])
					  .setPopup(new mapboxgl.Popup().setHTML(
					    `<h3 style="font-size:18px; text-align: center">${eventName}</h3>
					     <h3 style="font-size:14px; text-align: center">${startTime}</h3>`
					  ))

                      .addTo(map);

            map.addControl(new mapboxgl.NavigationControl());
            map.on('load', function() {
                window.setTimeout(function() {
                    map.resize();
                }, 200);
            });
        });

    </script>
</div>
</body>
</html>